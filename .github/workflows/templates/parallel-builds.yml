# Example: Parallel Multi-Target Builds with xcargo
#
# This workflow uses xcargo's parallel build feature to build
# multiple targets in a single job for faster CI times.

name: Parallel Builds

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-parallel:
    name: Build All Targets (Parallel)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Install xcargo
        run: |
          curl --proto '=https' --tlsv1.2 -LsSf \
            https://github.com/ibrahimcesar/xcargo/releases/latest/download/xcargo-installer.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install Zig
        run: |
          wget https://ziglang.org/download/0.11.0/zig-linux-x86_64-0.11.0.tar.xz
          tar -xf zig-linux-x86_64-0.11.0.tar.xz
          sudo mv zig-linux-x86_64-0.11.0/zig /usr/local/bin/
          zig version

      - name: Install cross-compilation toolchains
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc-aarch64-linux-gnu \
            gcc-arm-linux-gnueabihf \
            mingw-w64

      - name: Add Rust targets
        run: |
          rustup target add x86_64-unknown-linux-gnu
          rustup target add x86_64-unknown-linux-musl
          rustup target add aarch64-unknown-linux-gnu
          rustup target add armv7-unknown-linux-gnueabihf
          rustup target add x86_64-pc-windows-gnu

      - name: Build all targets (parallel)
        run: |
          xcargo build --release --target \
            x86_64-unknown-linux-gnu,\
            x86_64-unknown-linux-musl,\
            aarch64-unknown-linux-gnu,\
            armv7-unknown-linux-gnueabihf,\
            x86_64-pc-windows-gnu

      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: binaries-all-targets
          path: |
            target/*/release/${{ github.event.repository.name }}
            target/*/release/${{ github.event.repository.name }}.exe
